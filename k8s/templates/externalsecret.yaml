# ExternalSecret: sincroniza secrets do AWS Secrets Manager para Kubernetes
# O External Secrets Operator busca os secrets e cria um Kubernetes Secret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "fcg-payment-api.fullname" . }}-externalsecret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fcg-payment-api.labels" . | nindent 4 }}
spec:
  # Refresh automático a cada 1 hora
  refreshInterval: 1h
  
  # SecretStore define como acessar o AWS Secrets Manager
  secretStoreRef:
    name: {{ include "fcg-payment-api.fullname" . }}-secretstore
    kind: SecretStore
  
  # Nome do Kubernetes Secret que será criado
  target:
    name: {{ include "fcg-payment-api.fullname" . }}-secrets
    creationPolicy: Owner
  
  # Mapeamento: AWS Secrets Manager → Kubernetes Secret
  data:
    # Connection string do RDS (já existe no Secrets Manager)
    - secretKey: connectionString
      remoteRef:
        key: {{ .Values.secrets.connectionString.awsSecretName }}
    
    # URL da fila SQS (já existe no Secrets Manager)
    - secretKey: sqsQueueUrl
      remoteRef:
        key: {{ .Values.secrets.sqsQueueUrl.awsSecretName }}
